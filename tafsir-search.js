class TafsirSearchManager{constructor(){this.F={id:"i",page:"p",sura_n:"s",sura:"n",aya_n:"a",text:"t",tfsir:"m"},this.config={dataUrl:"data/tafsir.json",searchCacheSize:100,pageCacheSize:20,preloadRadius:2,maxConcurrentLoads:3},this.data=null,this.isLoaded=!1,this.isLoading=!1,this.loadPromise=null,this.searchCache=new Map,this.pageCache=new Map,this.loadedPages=new Set,this.surahsIndex=null,this.surahsMap=new Map,this.currentTafsirPage=null,this.previousTafsirPage=null,this.nextTafsirPage=null,this.currentSuraInView=null,this.scrollUpdateTimeout=null,this.tafsirUI=null,this.searchUI=null,this.tafsirUIReady=!1,this.stats={totalAyat:0,totalSuras:0,loadedPages:0},this.updatingDropdowns=!1,this.scrollThrottle=null,this.scrollTimeout=null,this.scrollHandlers=null,this.isScrolling=!1,this.isLoadingMore=!1,this.lastScrollTime=0,this.scrollRAF=null,this._suraChangeHandler=null,this._pageChangeHandler=null,this._ayaChangeHandler=null,this.lastResults=""}_sortByQuranOrder(t){return[...t].sort(((t,a)=>t[this.F.id]-a[this.F.id]))}_sortByAyaNum(t){return[...t].sort(((t,a)=>t[this.F.aya_n]-a[this.F.aya_n]))}_getFirstAyaOfPage(t){return t?.length?this._sortByQuranOrder(t)[0]:null}async preload(){if(!this.isLoaded&&!this.isLoading){this.isLoading=!0;try{await this.loadData(),this.isLoaded=!0,this.buildSurahsIndex()}catch(t){throw t}finally{this.isLoading=!1}}}async loadData(){try{const t=await fetch(this.config.dataUrl);if(!t.ok)throw new Error(`HTTP ${t.status}`);return this.data=await t.json(),this.initializeDataStructures(),window.dispatchEvent(new CustomEvent("tafsir:loaded",{detail:{ayatCount:this.data.length}})),this.data}catch(t){throw t}}initializeDataStructures(){if(!this.data?.length)return;this.stats.totalAyat=this.data.length;const t=new Set;this.data.forEach((a=>{t.add(a[this.F.sura_n]),a[this.F.page]&&this.loadedPages.add(a[this.F.page])})),this.stats.totalSuras=t.size,this.stats.loadedPages=this.loadedPages.size}async ensureLoaded(){return this.isLoaded||await this.preload(),this.data}buildSurahsIndex(){this.data?.length?(this.surahsMap.clear(),this.data.forEach((t=>{this.surahsMap.has(t[this.F.sura_n])||this.surahsMap.set(t[this.F.sura_n],{id:t[this.F.sura_n],name:t[this.F.sura],page_start:1/0,page_end:-1/0,verses:0});const a=this.surahsMap.get(t[this.F.sura_n]);t[this.F.page]<a.page_start&&(a.page_start=t[this.F.page]),t[this.F.page]>a.page_end&&(a.page_end=t[this.F.page]),t[this.F.aya_n]>a.verses&&(a.verses=t[this.F.aya_n])})),this.surahsIndex=Array.from(this.surahsMap.values()).sort(((t,a)=>t.id-a.id))):this.surahsIndex=[]}getSurahsIndex(){return this.surahsIndex||this.buildSurahsIndex(),this.surahsIndex}getFirstAyaForPage(t){const a=parseInt(t);if(!this.data||isNaN(a))return null;const e=this.getAyatByPage(a),s=this._getFirstAyaOfPage(e);return s?{sura_n:s[this.F.sura_n],sura:s[this.F.sura],aya_n:s[this.F.aya_n],page:s[this.F.page],isSuraStart:1===s[this.F.aya_n],id:s[this.F.id],ayatCountOnPage:e.length}:null}getAyatByPage(t){if(!this.data)return[];const a=parseInt(t);if(this.pageCache.has(a))return this.pageCache.get(a);const e=this.data.filter((t=>t[this.F.page]===a)),s=this._sortByQuranOrder(e);if(this.pageCache.size>=this.config.pageCacheSize){const t=this.pageCache.keys().next().value;this.pageCache.delete(t)}return this.pageCache.set(a,s),s}getAya(t,a){if(!this.data)return null;const e=parseInt(t),s=parseInt(a),i=this.data.find((t=>t[this.F.sura_n]===e&&t[this.F.aya_n]===s));return i?{sura_n:i[this.F.sura_n],sura:i[this.F.sura],aya_n:i[this.F.aya_n],text:i[this.F.text],page:i[this.F.page],tfsir:i[this.F.tfsir]}:null}getTafsir(t,a){const e=this.getAya(t,a);return e?{...e,hasTafsir:!!e.tfsir}:null}getAyatBySura(t){if(!this.data)return[];const a=parseInt(t),e=this.data.filter((t=>t[this.F.sura_n]===a));return this._sortByAyaNum(e)}searchWithStats(t){if(!this.data||!t?.trim())return{results:[],stats:{resultsCount:0,totalSuras:0}};const a=t.toLowerCase(),e=`combined_${a}`;if(this.searchCache.has(e))return this.searchCache.get(e);const s=[],i=new Set;let n=0;for(const t of this.data)t[this.F.text]?.toLowerCase().includes(a)&&(n++,i.add(t[this.F.sura_n]),s.length<1e3&&s.push({sura_n:t[this.F.sura_n],sura:t[this.F.sura],aya_n:t[this.F.aya_n],text:t[this.F.text],page:t[this.F.page],id:t[this.F.id]}));const r={results:this._sortByQuranOrder(s).slice(0,500),stats:{resultsCount:n,totalSuras:i.size}};return this.searchCache.size>=this.config.searchCacheSize&&this.searchCache.delete(this.searchCache.keys().next().value),this.searchCache.set(e,r),r}search(t){return this.searchWithStats(t).results}getSearchStats(t){return this.searchWithStats(t).stats}setupSearchUI(t,a,e){if(!t||!a)return null;this.inputElement=t,this.resultsElement=a,t.className="search-input",t.placeholder="Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…...";const s=t.parentElement;if(!s)return null;let i=s.querySelector(".search-stats");i||(i=document.createElement("div"),i.className="search-stats",s.appendChild(i));let n=null,r=null;const o=()=>{i.innerHTML=r?`\n                <div class="search-stats-content">\n                    <span>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«:</span>\n                    <span class="stat-results">${r.resultsCount}</span>\n                    <span>Ù…ÙˆØ¶Ø¹</span>\n                    <span>ÙÙŠ</span>\n                    <span class="stat-suras">${r.totalSuras}</span>\n                    <span>Ø³ÙˆØ±Ø©</span>\n                </div>\n            `:"<div></div>"},h=()=>{clearTimeout(n),n=setTimeout((()=>{if(!this.isLoaded)return a.innerHTML="",r=null,void o();const s=t.value;if(0===s.trim().length)return a.innerHTML="",r=null,void o();const{results:i,stats:n}=this.searchWithStats(s);if(r=n,o(),0===i.length)return a.innerHTML=`\n\n                <div class="search-empty">\n\n                    <p><b>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù€Ù€ :</b></p>\n\n                    <p>"${s}"</p>\n\n                    <p>Ø¬Ø±Ø¨ ğŸ” ÙƒÙ„Ù…Ø© Ø¨Ø­Ø« Ø£Ø®Ø±Ù‰</p>\n\n                    </div>\n                `,void(this.lastResults=a.innerHTML);let h="";i.forEach(((t,a)=>{h+=`\n<div class="item-container item-search" data-sura="${t.sura_n}" data-aya="${t.aya_n}">\n                    <div class="item-line-1">\n                        <div class="item-right">\n                            <span class="item-badge">${a+1}</span>\n                            <span class="item-title">${t.sura_n}. ${t.sura}</span>\n                        </div>\n                        <div class="item-left">\n                            <span class="item-tag">Øµ ${t.page}</span>\n                        </div>\n                    </div>\n                    <div class="item-line-2 item-search-text">\n                        ${t.text}\n                    </div>\n                </div>\n            `})),a.innerHTML=h,this.lastResults=h,a.querySelectorAll(".item-container").forEach((t=>{t.addEventListener("click",(()=>{const a=t.getAttribute("data-sura"),s=t.getAttribute("data-aya");e&&e(a,s)}))}))}),300)},l=t.cloneNode(!0);return t.parentNode.replaceChild(l,t),(t=l).addEventListener("input",h),t.addEventListener("keypress",(t=>{"Enter"===t.key&&h()})),setTimeout((()=>{try{t.focus()}catch(t){}}),100),o(),t.value.trim().length>0&&h(),this.searchUI={performSearch:h,clear:()=>{t.value="",a.innerHTML="",r=null,o(),this.lastResults=""},focus:()=>{try{t.focus()}catch(t){}}},this.searchUI}clearSearch(){this.resultsElement&&(this.resultsElement.innerHTML=""),this.lastResults="",this.inputElement&&(this.inputElement.value="")}renderTafsirContent(t,a){if(!t)return;if(t.innerHTML="",!a?.length)return;const e=this._sortByQuranOrder(a),s=new Set;e.forEach((a=>{if(1===a[this.F.aya_n]&&!s.has(a[this.F.sura_n])){const e=document.createElement("div");e.className="sura-title-container",e.dataset.sura=a[this.F.sura_n],e.dataset.page=a[this.F.page],e.innerHTML=`\n                    <div class="sura-badge">${a[this.F.sura_n]}</div>\n                    <div class="sura-name-kufi">Ø³ÙˆØ±Ø© ${a[this.F.sura]}</div>\n                `,t.appendChild(e),s.add(a[this.F.sura_n])}const e=this.getTafsir(a[this.F.sura_n],a[this.F.aya_n]);if(!e?.tfsir)return;const i=document.createElement("div");i.className="tafsir-aya-container",i.dataset.sura=a[this.F.sura_n],i.dataset.aya=a[this.F.aya_n],i.dataset.page=a[this.F.page],i.dataset.id=a[this.F.id],i.innerHTML=`\n                <div class="item-search-text">\n                    <div class="item-line-2 item-search-text">\n                        ${a[this.F.text]||""}\n                    </div>\n                    <div class="tafsir-explanation">\n                        ${e.tfsir||""}\n                    </div>\n                </div>\n            `,t.appendChild(i)}))}async initTafsirUI(t,a,e,s,i,n){this.optimizeForMobile(),this.tafsirUI={suraSelect:t,ayaSelect:a,pageSelect:e,contentContainer:s,onPageChange:i,onAyaClick:n},await this.ensureLoaded(),this.initializeTafsirSelectors(),this.initTafsirFontControls();const r=window.quranApp?.getCurrentPage()||1,o=this.getFirstAyaForPage(r);return o?(this.updateTafsirNavigation(o.sura_n,o.aya_n,r),this.syncDropdowns(o.sura_n,o.aya_n,r,"init"),await this.loadTafsirForPage(r),setTimeout((()=>this.scrollToFirstAyaOfPage(r)),150)):s.innerHTML="",s&&this.setupInfiniteScroll(s),this.tafsirUIReady=!0,this.tafsirUI}initializeTafsirSelectors(){if(!this.tafsirUI)return;const{suraSelect:t,ayaSelect:a,pageSelect:e}=this.tafsirUI;if(t&&a&&e){this._suraChangeHandler&&t.removeEventListener("change",this._suraChangeHandler),this._pageChangeHandler&&e.removeEventListener("change",this._pageChangeHandler),this._ayaChangeHandler&&a.removeEventListener("change",this._ayaChangeHandler),this._suraChangeHandler=()=>this.handleSuraChange(),this._pageChangeHandler=()=>this.handlePageChange(),this._ayaChangeHandler=()=>this.handleAyaChange(),t.addEventListener("change",this._suraChangeHandler),e.addEventListener("change",this._pageChangeHandler),a.addEventListener("change",this._ayaChangeHandler),t.innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø©</option>',this.getSurahsIndex().forEach((a=>{const e=document.createElement("option");e.value=a.id,e.textContent=`${a.id}. ${a.name}`,t.appendChild(e)})),e.innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙØ­Ø©</option>';for(let t=1;t<=604;t++){const a=document.createElement("option");a.value=t,a.textContent=`Ø§Ù„ØµÙØ­Ø© ${t}`,e.appendChild(a)}}}async handleSuraChange(){if(!this.tafsirUIReady||this.updatingDropdowns)return;this.updatingDropdowns=!0;const t=this.tafsirUI.suraSelect.value;if(t){const a=this.getAyatBySura(parseInt(t));if(a.length){const e=a[0];this.updateAyaDropdown(a),this.tafsirUI.ayaSelect.value=e[this.F.aya_n],this.tafsirUI.pageSelect.value=e[this.F.page],this.updateTafsirNavigation(e[this.F.sura_n],e[this.F.aya_n],e[this.F.page]),await this.loadTafsirForPage(e[this.F.page]),setTimeout((()=>this.scrollToFirstAyaOfSura(parseInt(t))),300)}}this.updatingDropdowns=!1}async handlePageChange(){if(!this.tafsirUIReady||this.updatingDropdowns)return;this.updatingDropdowns=!0;const t=this.tafsirUI.pageSelect.value;if(t){await this.loadTafsirForPage(t);const a=this.getAyatByPage(parseInt(t));if(a.length){const e=this._getFirstAyaOfPage(a);this.tafsirUI.suraSelect.value=e[this.F.sura_n],this.updateAyaDropdown(this.getAyatBySura(e[this.F.sura_n])),this.tafsirUI.ayaSelect.value=e[this.F.aya_n],this.updateTafsirNavigation(e[this.F.sura_n],e[this.F.aya_n],t),setTimeout((()=>this.scrollToFirstAyaOfPage(parseInt(t))),300)}}this.updatingDropdowns=!1}async handleAyaChange(){if(!this.tafsirUIReady||this.updatingDropdowns)return;this.updatingDropdowns=!0;const t=this.tafsirUI.suraSelect.value,a=this.tafsirUI.ayaSelect.value;if(t&&a){const e=this.getAyatBySura(parseInt(t)).find((t=>t[this.F.aya_n]===parseInt(a)));e&&(this.tafsirUI.pageSelect.value=e[this.F.page],this.updateTafsirNavigation(e[this.F.sura_n],e[this.F.aya_n],e[this.F.page]),await this.loadTafsirForPage(e[this.F.page]),setTimeout((()=>this.scrollToAya(e[this.F.sura_n],e[this.F.aya_n])),300))}this.updatingDropdowns=!1}updateAyaDropdown(t){const a=this.tafsirUI.ayaSelect;a&&(a.innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¢ÙŠØ©</option>',t.forEach((t=>{const e=document.createElement("option");e.value=t[this.F.aya_n],e.textContent=`Ø§Ù„Ø¢ÙŠØ© ${t[this.F.aya_n]}`,a.appendChild(e)})))}syncDropdowns(t,a,e,s="scroll"){if(this.updatingDropdowns&&"init"!==s||!this.tafsirUI)return;if("scroll"===s&&this.isScrolling)return;this.updatingDropdowns=!0;const{suraSelect:i,ayaSelect:n,pageSelect:r}=this.tafsirUI;try{if(t&&i.value!=t){i.value=t;const a=this.getAyatBySura(t);n.innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¢ÙŠØ©</option>',a.forEach((t=>{const a=document.createElement("option");a.value=t[this.F.aya_n],a.textContent=`Ø§Ù„Ø¢ÙŠØ© ${t[this.F.aya_n]}`,n.appendChild(a)}))}a&&n.value!=a&&(n.value=a),e&&r.value!=e&&(r.value=e)}finally{setTimeout((()=>{this.updatingDropdowns=!1}),50)}}updateTafsirNavigation(t,a,e){this.currentTafsirPage=parseInt(e),this.previousTafsirPage=Math.max(1,this.currentTafsirPage-1),this.nextTafsirPage=Math.min(604,this.currentTafsirPage+1),this.currentSuraInView=parseInt(t)}async loadTafsirForPage(t){if(!this.tafsirUI?.contentContainer)return;const{contentContainer:a}=this.tafsirUI;await this.smartPreloadAround(t);const e=Array.from(this.pageCache.keys()).sort(((t,a)=>t-a)),s=e.indexOf(parseInt(t));if(-1===s)return void(a.innerHTML="");const i=Math.max(0,s-this.config.preloadRadius),n=Math.min(e.length-1,s+this.config.preloadRadius),r=e.slice(i,n+1);let o=[];if(r.forEach((t=>{const a=this.pageCache.get(t);a&&(o=o.concat(a))})),o=this._sortByQuranOrder(o),o.length){this.renderTafsirContent(a,o);const e=this.getAyatByPage(t);if(e?.length){const a=this._getFirstAyaOfPage(e);this.updateTafsirNavigation(a[this.F.sura_n],a[this.F.aya_n],t),this.syncDropdowns(a[this.F.sura_n],a[this.F.aya_n],t,"init")}}else a.innerHTML=""}setupInfiniteScroll(t){if(!t)return;this.scrollHandlers&&(this.scrollHandlers.container.removeEventListener("scroll",this.scrollHandlers.handler),this.scrollTimeout&&(clearTimeout(this.scrollTimeout),this.scrollTimeout=null),this.scrollRAF&&(cancelAnimationFrame(this.scrollRAF),this.scrollRAF=null));let a=0,e=!1;const s=()=>{const s=Date.now();if(s-a<150)return this.scrollTimeout&&clearTimeout(this.scrollTimeout),void(this.scrollTimeout=setTimeout((()=>{this.processScroll(t),a=Date.now()}),150));a=s,e||(e=!0,this.scrollRAF=requestAnimationFrame((()=>{this.processScroll(t),e=!1})))};t.addEventListener("scroll",s,{passive:!0}),this.scrollHandlers={container:t,handler:s}}processScroll(t){this.isScrolling||this.isLoadingMore||(this.handleScrollPosition(t),this.checkAndLoadMorePages(t),this.cleanupDistantPages())}handleScrollPosition(t){if(!t||this.isScrolling)return;const a=t.querySelectorAll(".tafsir-aya-container");if(!a.length)return;const e=t.getBoundingClientRect(),s=e.top,i=s+.4*e.height;let n=null;for(let t=a.length-1;t>=0;t--){const e=a[t],r=e.getBoundingClientRect(),o=r.top+r.height/2;if(o>=s&&o<=i){n=e;break}if(r.bottom<=s){n=n||e;break}}if(!n&&a.length&&(n=a[0]),n){const t=parseInt(n.dataset.sura),a=parseInt(n.dataset.aya),e=parseInt(n.dataset.page);clearTimeout(this.scrollUpdateTimeout),this.scrollUpdateTimeout=setTimeout((()=>{requestAnimationFrame((()=>{this.updateTafsirNavigation(t,a,e),this.syncDropdowns(t,a,e,"scroll")}))}),100)}}async checkAndLoadMorePages(t){if(this.isScrolling||this.isLoadingMore)return;const a=t.scrollTop,e=t.scrollHeight,s=t.clientHeight;e<=0||s<=0||(a+s>=.8*e&&this.nextTafsirPage?await this.loadNextPage(t):a<=.2*s&&this.previousTafsirPage&&await this.loadPreviousPage(t))}async loadNextPage(t){if(!this.nextTafsirPage||this.nextTafsirPage>604||this.isLoadingMore)return;this.isLoadingMore=!0;const a=this.nextTafsirPage;try{this.pageCache.has(a)||await this.loadPageToCache(a);const e=this.pageCache.get(a);e&&this.tafsirUI?.contentContainer&&(this.appendAyatToContainer(t,e),this.nextTafsirPage=Math.min(604,a+1),this.cleanupDistantPages())}catch(t){}setTimeout((()=>{this.isLoadingMore=!1}),100)}async loadPreviousPage(t){if(!this.previousTafsirPage||this.previousTafsirPage<1||this.isLoadingMore)return;this.isLoadingMore=!0;const a=this.previousTafsirPage;try{this.pageCache.has(a)||await this.loadPageToCache(a);const e=this.pageCache.get(a);if(e&&this.tafsirUI?.contentContainer){const s=t.scrollHeight;this.prependAyatToContainer(t,e);const i=t.scrollHeight;t.scrollTop+=i-s,this.previousTafsirPage=Math.max(1,a-1),this.cleanupDistantPages()}}catch(t){}setTimeout((()=>{this.isLoadingMore=!1}),100)}async smartPreloadAround(t){this.isLoaded||await this.ensureLoaded();const a=parseInt(t),e=new Set;e.add(a);for(let t=1;t<=this.config.preloadRadius;t++)a-t>=1&&e.add(a-t),a+t<=604&&e.add(a+t);const s=Array.from(e).filter((t=>!this.pageCache.has(t)));for(let t=0;t<s.length;t+=this.config.maxConcurrentLoads){const a=s.slice(t,t+this.config.maxConcurrentLoads);await Promise.all(a.map((t=>this.loadPageToCache(t))))}this.cleanupPageCache(a)}async loadPageToCache(t){return this.data||await this.ensureLoaded(),this.getAyatByPage(t)}cleanupPageCache(t){if(this.pageCache.size<=this.config.pageCacheSize)return;const a=2*this.config.preloadRadius,e=new Set;for(let s=-a;s<=a;s++){const a=t+s;a>=1&&a<=604&&e.add(a)}Array.from(this.pageCache.keys()).forEach((t=>{e.has(t)||this.pageCache.delete(t)}))}cleanupDistantPages(){if(!this.tafsirUI?.contentContainer||!this.currentTafsirPage)return;const t=this.tafsirUI.contentContainer,a=this.config.preloadRadius+1,e=Math.max(1,this.currentTafsirPage-a),s=Math.min(604,this.currentTafsirPage+a);t.querySelectorAll("[data-page]").forEach((t=>{const a=parseInt(t.dataset.page);isNaN(a)||(a<e||a>s)&&t.remove()}))}appendAyatToContainer(t,a){if(!a?.length)return;const e=this._sortByQuranOrder(a),s=document.createDocumentFragment();e.forEach((a=>{if(1===a[this.F.aya_n]&&!t.querySelector(`.sura-title-container[data-sura="${a[this.F.sura_n]}"]`)){const t=document.createElement("div");t.className="sura-title-container",t.dataset.sura=a[this.F.sura_n],t.dataset.page=a[this.F.page],t.innerHTML=`\n                        <div class="sura-badge">${a[this.F.sura_n]}</div>\n                        <div class="sura-name-kufi">Ø³ÙˆØ±Ø© ${a[this.F.sura]}</div>\n                    `,s.appendChild(t)}const e=this.getTafsir(a[this.F.sura_n],a[this.F.aya_n]);if(!e?.tfsir)return;if(t.querySelector(`[data-sura="${a[this.F.sura_n]}"][data-aya="${a[this.F.aya_n]}"]`))return;const i=document.createElement("div");i.className="tafsir-aya-container",i.dataset.sura=a[this.F.sura_n],i.dataset.aya=a[this.F.aya_n],i.dataset.page=a[this.F.page],i.dataset.id=a[this.F.id],i.innerHTML=`\n                <div class="item-search-text">\n                    <div class="item-line-2 item-search-text">\n                        ${a[this.F.text]||""}\n                    </div>\n                    <div class="tafsir-explanation">\n                        ${e.tfsir||""}\n                    </div>\n                </div>\n            `,s.appendChild(i)})),t.appendChild(s)}prependAyatToContainer(t,a){if(!a?.length)return;const e=this._sortByQuranOrder(a),s=document.createDocumentFragment();e.forEach((a=>{if(1===a[this.F.aya_n]&&!t.querySelector(`.sura-title-container[data-sura="${a[this.F.sura_n]}"]`)){const t=document.createElement("div");t.className="sura-title-container",t.dataset.sura=a[this.F.sura_n],t.dataset.page=a[this.F.page],t.innerHTML=`\n                        <div class="sura-badge">${a[this.F.sura_n]}</div>\n                        <div class="sura-name-kufi">Ø³ÙˆØ±Ø© ${a[this.F.sura]}</div>\n                    `,s.appendChild(t)}const e=this.getTafsir(a[this.F.sura_n],a[this.F.aya_n]);if(!e?.tfsir)return;if(t.querySelector(`[data-sura="${a[this.F.sura_n]}"][data-aya="${a[this.F.aya_n]}"]`))return;const i=document.createElement("div");i.className="tafsir-aya-container",i.dataset.sura=a[this.F.sura_n],i.dataset.aya=a[this.F.aya_n],i.dataset.page=a[this.F.page],i.dataset.id=a[this.F.id],i.innerHTML=`\n                <div class="item-search-text">\n                    <div class="item-line-2 item-search-text">\n                        ${a[this.F.text]||""}\n                    </div>\n                    <div class="tafsir-explanation">\n                        ${e.tfsir||""}\n                    </div>\n                </div>\n            `,s.appendChild(i)})),t.firstChild?t.insertBefore(s,t.firstChild):t.appendChild(s)}scrollToFirstAyaOfPage(t){const a=this.tafsirUI?.contentContainer;a&&setTimeout((()=>{const e=a.querySelector(`[data-page="${t}"]`);if(!e)return;this.isScrolling=!0;const s=a.getBoundingClientRect(),i=e.getBoundingClientRect().top-s.top+a.scrollTop;if(a.scrollTop=i,e.classList.contains("tafsir-aya-container")){const a=parseInt(e.dataset.sura),s=parseInt(e.dataset.aya);this.updateTafsirNavigation(a,s,t),this.syncDropdowns(a,s,t,"scroll")}else{const a=parseInt(e.dataset.sura),s=this.getAyatBySura(a)[0];s&&(this.updateTafsirNavigation(a,s[this.F.aya_n],t),this.syncDropdowns(a,s[this.F.aya_n],t,"scroll"))}setTimeout((()=>{this.isScrolling=!1}),100)}),100)}scrollToFirstAyaOfSura(t){const a=this.tafsirUI?.contentContainer;if(!a)return;const e=a.querySelector(`[data-sura="${t}"]`);if(e){const t=a.getBoundingClientRect(),s=e.getBoundingClientRect().top-t.top+a.scrollTop-20;"scrollBehavior"in document.documentElement.style?a.scrollTo({top:s,behavior:"smooth"}):a.scrollTop=s}}scrollToAya(t,a){const e=this.tafsirUI?.contentContainer;if(!e)return;const s=e.querySelector(`[data-sura="${t}"][data-aya="${a}"]`);if(s){const t=e.getBoundingClientRect(),a=s.getBoundingClientRect().top-t.top+e.scrollTop-20;"scrollBehavior"in document.documentElement.style?e.scrollTo({top:a,behavior:"smooth"}):e.scrollTop=a}}optimizeForMobile(){if(("ontouchstart"in window||navigator.maxTouchPoints>0||window.innerWidth<=768)&&(this.config.searchCacheSize=50,this.config.pageCacheSize=10,this.config.preloadRadius=1,this.config.maxConcurrentLoads=2,window.devicePixelRatio>2&&(this.config.searchCacheSize=30,this.config.pageCacheSize=5),window.performance?.memory)){const t=window.performance.memory;t.usedJSHeapSize/t.jsHeapSizeLimit>.7&&(this.config.preloadRadius=0)}}initTafsirFontControls(){this.fontSizeObserver&&(this.fontSizeObserver.disconnect(),this.fontSizeObserver=null),this.themeChangeHandler&&(window.removeEventListener("quran:themeChanged",this.themeChangeHandler),this.themeChangeHandler=null),requestAnimationFrame((()=>{const t=document.getElementById("tafsirFontDecrease"),a=document.getElementById("tafsirFontIncrease"),e=document.getElementById("tafsirFontReset"),s=document.getElementById("tafsirThemeToggle"),i=this.tafsirUI?.contentContainer;if(!(t&&a&&e&&s))return;if(!i)return;let n=parseInt(localStorage.getItem("tafsir_font_size"))||16;n=Math.min(32,Math.max(12,n));const r=t=>{i.style.fontSize=t+"px",i.querySelectorAll(".item-search-text, .tafsir-explanation, .sura-name-kufi").forEach((a=>{a.style.fontSize=t+"px"}))};r(n);const o=()=>{const t=document.body.classList.contains("night-mode");s.textContent=t?"â˜€ï¸":"ğŸŒ™",s.setAttribute("aria-label",t?"Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ":"Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ")};o();const h=a.cloneNode(!0),l=t.cloneNode(!0),c=e.cloneNode(!0),d=s.cloneNode(!0);a.parentNode.replaceChild(h,a),t.parentNode.replaceChild(l,t),e.parentNode.replaceChild(c,e),s.parentNode.replaceChild(d,s),h.addEventListener("click",(()=>{n=Math.min(32,n+2),r(n),localStorage.setItem("tafsir_font_size",n),window.quranApp?.showToast&&window.quranApp.showToast(`ğŸ“ Ø­Ø¬Ù… Ø§Ù„Ù†Øµ: ${n}px`)})),l.addEventListener("click",(()=>{n=Math.max(12,n-2),r(n),localStorage.setItem("tafsir_font_size",n),window.quranApp?.showToast&&window.quranApp.showToast(`ğŸ“ Ø­Ø¬Ù… Ø§Ù„Ù†Øµ: ${n}px`)})),c.addEventListener("click",(()=>{n=16,r(16),localStorage.setItem("tafsir_font_size",16),window.quranApp?.showToast&&window.quranApp.showToast("ğŸ“ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ")})),d.addEventListener("click",(()=>{window.quranApp&&"function"==typeof window.quranApp.toggleTheme?(window.quranApp.toggleTheme(),o()):(document.body.classList.toggle("night-mode"),o(),localStorage.setItem("quran_theme",document.body.classList.contains("night-mode")?"night":"light"))}));const u=()=>o();window.addEventListener("quran:themeChanged",u);const g=new MutationObserver((t=>{t.forEach((t=>{"childList"===t.type&&t.addedNodes.length>0&&t.addedNodes.forEach((t=>{1===t.nodeType&&(t.matches?.(".item-search-text, .tafsir-explanation, .sura-name-kufi")&&(t.style.fontSize=n+"px"),t.querySelectorAll?.(".item-search-text, .tafsir-explanation, .sura-name-kufi").forEach((t=>{t.style.fontSize=n+"px"})))}))}))}));g.observe(i,{childList:!0,subtree:!0}),this.fontSizeObserver=g,this.themeChangeHandler=u}))}}window.tafsirManager=new TafsirSearchManager,"undefined"!=typeof window&&(window.TafsirSearchManager=TafsirSearchManager),setTimeout((()=>{window.tafsirManager.isLoaded||window.tafsirManager.isLoading||"visible"===document.visibilityState&&window.tafsirManager.preload().catch((t=>{}))}),1e4);