class QuranApp{constructor(){this.isInitialized=!1,this.bookmarks=[],this.lastPage=1,this.theme="light",this.NOTIFICATION_DURATION=1e3,this.tafsirLoaded=!1,this.tafsirLoading=!1,this.tafsirLoadQueue=[],this.pinnedSurahs=[],this._beforeUnloadHandler=null,this._pageHideHandler=null,this._visibilityChangeHandler=null,this._onlineHandler=null,this._offlineHandler=null,this._pageChangedHandler=null,this._bookmarkChangedHandler=null,this._readingModeChangedHandler=null}async init(){if(!this.isInitialized)try{this.restoreFromLocalStorage(),this.applyTheme(),await this.initCalculator(),await this.initReader(),this.initOverlays(),this.setupEventListeners(),this.updateBookmarkIcon(this.lastPage),this.setupCleanupHandlers(),this.isInitialized=!0,window.dispatchEvent(new CustomEvent("quran:appReady"))}catch(e){this.showToast("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ"),window.dispatchEvent(new CustomEvent("quran:appError",{detail:{error:e.message}}))}}restoreFromLocalStorage(){try{const e=localStorage.getItem("quran_bookmarks");this.bookmarks=e?JSON.parse(e):[],this.bookmarks=this.bookmarks.map(((e,t)=>"number"==typeof e?{page:e,name:`ÿµŸÅÿ≠ÿ© ${e}`,date:(new Date).toISOString(),id:`bookmark_${e}_${Date.now()}_${t}`}:{...e,id:e.id||`bookmark_${e.page}_${Date.now()}_${t}`}));const t=localStorage.getItem("quran_lastPage");this.lastPage=t?parseInt(t):1,(isNaN(this.lastPage)||this.lastPage<1||this.lastPage>604)&&(this.lastPage=1),this.theme=localStorage.getItem("quran_theme")||"light";const a=localStorage.getItem("quran_pinnedSurahs");this.pinnedSurahs=a?JSON.parse(a):[]}catch(e){this.bookmarks=[],this.lastPage=1,this.theme="light",this.pinnedSurahs=[],["quran_bookmarks","quran_lastPage","quran_theme","quran_pinnedSurahs"].forEach((e=>localStorage.removeItem(e))),localStorage.removeItem("quran_readingMode"),localStorage.removeItem("quran_lastMode"),localStorage.setItem("quran_lastPage","1"),localStorage.setItem("quran_theme","light"),localStorage.setItem("quran_bookmarks","[]"),localStorage.setItem("quran_pinnedSurahs","[]")}}saveToLocalStorage(){try{localStorage.setItem("quran_bookmarks",JSON.stringify(this.bookmarks)),localStorage.setItem("quran_lastPage",this.lastPage.toString()),localStorage.setItem("quran_theme",this.theme),localStorage.setItem("quran_pinnedSurahs",JSON.stringify(this.pinnedSurahs)),window.quranReader&&localStorage.setItem("quran_readingMode",window.quranReader.readingMode)}catch(e){localStorage.setItem("quran_lastPage",this.lastPage.toString())}}getCurrentPage(){return this.lastPage}updateCurrentPage(e){const t=parseInt(e);!isNaN(t)&&t>=1&&t<=604&&(this.lastPage=t,localStorage.setItem("quran_lastPage",t.toString()),"undefined"!=typeof window&&(window.currentQuranPage=t))}goToPage(e){window.quranReader&&window.quranReader.goToPage(e)}togglePinSurah(e){const t=this.pinnedSurahs.indexOf(e);return-1===t?this.pinnedSurahs.push(e):this.pinnedSurahs.splice(t,1),this.saveToLocalStorage(),window.dispatchEvent(new CustomEvent("quran:pinnedSurahsUpdated")),-1===t}isSurahPinned(e){return this.pinnedSurahs.includes(e)}getPinnedSurahs(){return[...this.pinnedSurahs]}getBookmarks(){return[...this.bookmarks]}async openBookmark(){window.overlayManager&&window.overlayManager.showBookmarks()}addBookmark(e){this.bookmarks.push(e),this.bookmarks.sort(((e,t)=>e.page-t.page)),this.saveToLocalStorage(),this.updateBookmarkIcon(e.page),window.dispatchEvent(new CustomEvent("quran:bookmarkChanged")),window.dispatchEvent(new CustomEvent("quran:bookmarkAdded",{detail:{bookmark:e}}))}replaceBookmarkPage(e,t){const a=this.bookmarks.find((t=>t.id===e));if(!a)return!1;if(t<1||t>604)return!1;const o=a.page;return a.page=t,this.bookmarks.sort(((e,t)=>e.page-t.page)),this.saveToLocalStorage(),this.updateBookmarkIcon(o),this.updateBookmarkIcon(t),window.dispatchEvent(new CustomEvent("quran:bookmarkChanged")),!0}removeBookmarkById(e){const t=this.bookmarks.findIndex((t=>t.id===e));if(t>-1){const e=this.bookmarks.splice(t,1)[0];return this.saveToLocalStorage(),this.updateBookmarkIcon(e.page),window.dispatchEvent(new CustomEvent("quran:bookmarkRemoved",{detail:{bookmark:e}})),!0}return!1}updateBookmark(e,t){const a=this.bookmarks.find((t=>t.id===e));return!!a&&(a.name=t.trim()||`ÿµŸÅÿ≠ÿ© ${a.page}`,this.saveToLocalStorage(),window.dispatchEvent(new CustomEvent("quran:bookmarkChanged")),!0)}updateBookmarkIcon(e){const t=document.getElementById("bookmarkIcon");if(!t)return;const a=this.bookmarks.some((t=>t.page===e));t.textContent=a?"‚≠ê":"üîñ",t.title=a?"ÿπŸÑÿßŸÖÿ© ŸÖÿ±ÿ¨ÿπŸäÿ© ŸÖŸàÿ¨ŸàÿØÿ©":"ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÑÿßŸÖÿ© ŸÖÿ±ÿ¨ÿπŸäÿ©"}async loadTafsir(){if(this.tafsirLoaded)return!0;if(this.tafsirLoading)return new Promise((e=>{this.tafsirLoadQueue.push(e)}));this.tafsirLoading=!0;try{if(!window.tafsirManager)throw new Error("Module TafsirManager non trouv√©");const e=window.tafsirManager.preload(),t=new Promise(((e,t)=>setTimeout((()=>t(new Error("Timeout"))),2e4)));return await Promise.race([e,t]),this.tafsirLoaded=!0,this.tafsirLoading=!1,this.tafsirLoadQueue.forEach((e=>e(!0))),this.tafsirLoadQueue=[],window.dispatchEvent(new CustomEvent("tafsir:ready")),!0}catch(e){return this.tafsirLoaded=!1,this.tafsirLoading=!1,this.tafsirLoadQueue.forEach((e=>e(!1))),this.tafsirLoadQueue=[],this.showToast("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ±"),!1}}toggleTheme(){const e=document.body.classList.toggle("night-mode");this.theme=e?"night":"light",this.saveToLocalStorage(),this.updateAllThemeIcons(),window.dispatchEvent(new CustomEvent("quran:themeChanged",{detail:{theme:this.theme}})),this.showToast(e?"üåô ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÑŸäŸÑŸä":"‚òÄÔ∏è ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÜŸáÿßÿ±Ÿä")}updateAllThemeIcons(){const e=document.getElementById("tafsirThemeToggle");if(e){const t=document.body.classList.contains("night-mode");e.textContent=t?"‚òÄÔ∏è":"üåô"}window.overlayManager&&window.overlayManager.updateThemeButtonText()}applyTheme(){"night"===this.theme?document.body.classList.add("night-mode"):document.body.classList.remove("night-mode")}async initCalculator(){if(!window.quranCalculator)throw new Error("Module Calculator non trouv√©");try{await window.quranCalculator.load()}catch(e){throw e}}async initReader(){if(!window.quranReader)throw new Error("Module Reader non trouv√©");try{await window.quranReader.init({},this.lastPage)}catch(e){throw e}}initOverlays(){if(!window.overlayManager)throw new Error("Module OverlayManager non trouv√©");try{window.overlayManager.init({app:this})}catch(e){throw e}}setupEventListeners(){const e=e=>{if(e.detail?.page){const t=e.detail.page;this.lastPage=t,this.updateCurrentPage(t),this.updateBookmarkIcon(t),"undefined"!=typeof window&&(window.currentQuranPage=t)}};window.addEventListener("quran:pageChanged",e);const t=()=>{this.updateBookmarkIcon(this.lastPage)};window.addEventListener("quran:bookmarkChanged",t);const a=e=>{e.detail?.savedPage&&(this.lastPage=e.detail.savedPage,this.updateCurrentPage(e.detail.savedPage))};window.addEventListener("quran:readingModeChanged",a);const o=e=>{const t=document.querySelector(".overlay.show"),a=document.querySelector(".menu-overlay.show");if(t){const a=t.querySelector(".overlay-body");switch(e.key){case"ArrowDown":e.preventDefault(),a&&a.scrollBy({top:120,behavior:"smooth"});break;case"ArrowUp":e.preventDefault(),a&&a.scrollBy({top:-120,behavior:"smooth"});break;case"Home":e.preventDefault(),a&&(a.scrollTop=0);break;case"End":e.preventDefault(),a&&(a.scrollTop=a.scrollHeight);break}return}if(a)return;const o=window.quranReader;if(o)switch(e.key){case"ArrowLeft":case"PageDown":e.preventDefault(),o.goToNextPage();break;case"ArrowRight":case"PageUp":e.preventDefault(),o.goToPreviousPage();break;case"ArrowUp":e.preventDefault(),"scroll"===o.readingMode&&o.elements.pageScroll?.scrollBy({top:-120,behavior:"smooth"});break;case"ArrowDown":e.preventDefault(),"scroll"===o.readingMode&&o.elements.pageScroll?.scrollBy({top:120,behavior:"smooth"});break;case"Home":e.preventDefault(),o.goToFirstPage();break;case"End":e.preventDefault(),o.goToLastPage();break}};document.addEventListener("keydown",o),this._keyDownHandler=o,this._pageChangedHandler=e,this._bookmarkChangedHandler=t,this._readingModeChangedHandler=a}setupCleanupHandlers(){this._beforeUnloadHandler=()=>{this.isInitialized&&this.saveToLocalStorage()},window.addEventListener("beforeunload",this._beforeUnloadHandler),this._pageHideHandler=()=>{this.isInitialized&&this.saveToLocalStorage()},window.addEventListener("pagehide",this._pageHideHandler),this._visibilityChangeHandler=()=>{"hidden"===document.visibilityState?(this.saveToLocalStorage(),window.quranReader&&window.quranReader.imageCache.clear()):"visible"===document.visibilityState&&window.quranReader&&"function"==typeof window.quranReader.onAppResume&&window.quranReader.onAppResume()},document.addEventListener("visibilitychange",this._visibilityChangeHandler);const e=()=>{window.quranApp?.showToast("‚úÖ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ŸÖÿ™ŸàŸÅÿ±")},t=()=>{window.quranApp?.showToast("‚ö†Ô∏è ÿ™ŸÖ ŸÅŸÇÿØÿßŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™")};window.addEventListener("online",e),window.addEventListener("offline",t),this._onlineHandler=e,this._offlineHandler=t}showToast(e){const t=document.getElementById("toast");t&&(t.timeoutId&&clearTimeout(t.timeoutId),t.textContent=e,t.style.display="block",t.style.opacity="1",t.classList.add("show"),t.timeoutId=setTimeout((()=>{t.style.opacity="0",t.classList.remove("show"),setTimeout((()=>{t.style.display="none"}),300)}),this.NOTIFICATION_DURATION))}}window.quranApp||(window.quranApp=new QuranApp),"undefined"==typeof window||window.currentQuranPage||(window.currentQuranPage=1);